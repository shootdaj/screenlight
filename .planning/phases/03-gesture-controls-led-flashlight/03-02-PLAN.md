---
phase: 03-gesture-controls-led-flashlight
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt
  - app/src/main/java/com/anshul/screenlight/MainActivity.kt
  - app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt
autonomous: true

must_haves:
  truths:
    - "While holding volume button, tilting phone flat to upright adjusts screen brightness smoothly"
    - "While holding volume button, tilting phone left to right changes color temperature"
    - "Long-pressing any volume button toggles camera LED flashlight on/off"
    - "Double-tapping screen toggles light on/off"
    - "Double-clicking volume button closes the app"
    - "Sensor listeners unregister properly when volume button released"
  artifacts:
    - path: "app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt"
      provides: "Gesture state management and tilt observation control"
      contains: "GestureState"
    - path: "app/src/main/java/com/anshul/screenlight/MainActivity.kt"
      provides: "Volume button event handling with long-press and double-click detection"
      contains: "onKeyLongPress"
    - path: "app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt"
      provides: "Double-tap gesture detection on full screen"
      contains: "detectTapGestures"
  key_links:
    - from: "MainActivity.onKeyDown"
      to: "LightViewModel.onVolumeButtonDown"
      via: "direct method call"
      pattern: "viewModel.onVolumeButtonDown"
    - from: "LightViewModel.startTiltObservation"
      to: "TiltGestureManager.observeTilt"
      via: "Flow collection in viewModelScope"
      pattern: "tiltGestureManager.observeTilt"
    - from: "LightScreen detectTapGestures"
      to: "LightViewModel.onScreenDoubleTap"
      via: "onDoubleTap callback"
      pattern: "onDoubleTap.*onScreenDoubleTap"
---

<objective>
Wire gesture controls into ViewModel and UI layers for eyes-free operation.

Purpose: Enable users to adjust brightness and color by tilting the phone while holding a volume button, toggle the LED flashlight with long-press, toggle the screen light with double-tap, and close the app with volume double-click. All interactions are gesture-based for use in the dark without looking at the screen.

Output: Extended LightViewModel with gesture state management, MainActivity with volume button event handlers (onKeyDown/onKeyUp/onKeyLongPress), and LightScreen with detectTapGestures for double-tap toggle.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gesture-controls-led-flashlight/03-RESEARCH.md
@.planning/phases/03-gesture-controls-led-flashlight/03-01-SUMMARY.md

# Files to modify
@app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt
@app/src/main/java/com/anshul/screenlight/MainActivity.kt
@app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LightViewModel with gesture state management</name>
  <files>app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt</files>
  <action>
Extend LightViewModel with gesture controls. Inject new dependencies and add gesture state management:

1. **Add constructor dependencies:**
   - TiltGestureManager
   - FlashlightController

2. **Add GestureState data class:**
   ```kotlin
   data class GestureState(
       val isVolumeHeld: Boolean = false,
       val isTorchOn: Boolean = false,
       val shouldCloseApp: Boolean = false,
       val lastNonZeroBrightness: Float = 0.5f,
       val isLightOn: Boolean = true  // For double-tap toggle
   )
   ```

3. **Add gesture state Flow:**
   ```kotlin
   private val _gestureState = MutableStateFlow(GestureState())
   val gestureState: StateFlow<GestureState> = _gestureState.asStateFlow()
   ```

4. **Add tilt observation job tracking:**
   ```kotlin
   private var tiltJob: Job? = null
   ```

5. **Observe torch state in init:**
   ```kotlin
   viewModelScope.launch {
       flashlightController.torchState.collect { enabled ->
           _gestureState.update { it.copy(isTorchOn = enabled) }
       }
   }
   ```

6. **Volume button handlers:**

   **onVolumeButtonDown():**
   - Update gestureState: isVolumeHeld = true
   - Call startTiltObservation()

   **onVolumeButtonUp():**
   - Update gestureState: isVolumeHeld = false
   - Call stopTiltObservation()
   - Save lastNonZeroBrightness if current brightness > 0

   **onVolumeButtonLongPress():**
   - Call flashlightController.toggleTorch()

   **onVolumeButtonDoubleClick():**
   - Update gestureState: shouldCloseApp = true

7. **Tilt observation methods:**

   **startTiltObservation():**
   ```kotlin
   private fun startTiltObservation() {
       tiltJob?.cancel()
       tiltJob = viewModelScope.launch {
           tiltGestureManager.observeTilt().collect { tilt ->
               val brightness = TiltMapper.pitchToBrightness(tilt.pitch)
               val colorIndex = TiltMapper.rollToColorIndex(tilt.roll, COLOR_PRESETS.size)

               // Only update if gesture mode active
               if (_gestureState.value.isVolumeHeld) {
                   updateBrightness(brightness)
                   updateColor(COLOR_PRESETS[colorIndex])
               }
           }
       }
   }
   ```

   **stopTiltObservation():**
   ```kotlin
   private fun stopTiltObservation() {
       tiltJob?.cancel()
       tiltJob = null
   }
   ```

8. **Screen double-tap handler:**

   **onScreenDoubleTap():**
   - Toggle isLightOn state
   - If turning off: save current brightness to lastNonZeroBrightness, set brightness to 0
   - If turning on: restore lastNonZeroBrightness
   ```kotlin
   fun onScreenDoubleTap() {
       viewModelScope.launch {
           val currentlyOn = _gestureState.value.isLightOn
           if (currentlyOn) {
               // Turning off - save current brightness
               val current = _uiState.value.settings.brightness
               if (current > 0f) {
                   _gestureState.update { it.copy(lastNonZeroBrightness = current) }
               }
               settingsRepository.updateBrightness(0f)
           } else {
               // Turning on - restore saved brightness
               settingsRepository.updateBrightness(_gestureState.value.lastNonZeroBrightness)
           }
           _gestureState.update { it.copy(isLightOn = !currentlyOn) }
       }
   }
   ```

9. **clearCloseAppFlag():** Reset shouldCloseApp to false after Activity reads it.

**Critical:** Tilt observation starts ONLY when volume is held and stops when released. This prevents accidental brightness/color changes during normal phone use.
  </action>
  <verify>
- `./gradlew assembleDebug` compiles without errors
- LightViewModel has TiltGestureManager and FlashlightController injected
- GestureState data class exists with all required fields
- Methods exist: onVolumeButtonDown, onVolumeButtonUp, onVolumeButtonLongPress, onVolumeButtonDoubleClick, onScreenDoubleTap
- TiltMapper is used to convert tilt angles to brightness/color
  </verify>
  <done>
LightViewModel extended with complete gesture state management: tilt observation controlled by volume button hold, flashlight toggle on long-press, app close on double-click, screen light toggle on double-tap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add volume button handling to MainActivity and double-tap to LightScreen</name>
  <files>
    app/src/main/java/com/anshul/screenlight/MainActivity.kt
    app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt
  </files>
  <action>
**Part A: Update MainActivity with volume button handlers**

1. **Add ViewModel injection:**
   ```kotlin
   private val viewModel: LightViewModel by viewModels()
   ```

2. **Add double-click detection state:**
   ```kotlin
   private var lastVolumeClickTime = 0L
   private val doubleClickThreshold = 300L
   ```

3. **Override onKeyDown:**
   ```kotlin
   override fun onKeyDown(keyCode: Int, event: KeyEvent): Boolean {
       if (keyCode == KeyEvent.KEYCODE_VOLUME_UP || keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) {
           event.startTracking()  // Enable long-press detection
           viewModel.onVolumeButtonDown()
           return true  // Consume event - prevent volume change
       }
       return super.onKeyDown(keyCode, event)
   }
   ```

4. **Override onKeyLongPress:**
   ```kotlin
   override fun onKeyLongPress(keyCode: Int, event: KeyEvent): Boolean {
       if (keyCode == KeyEvent.KEYCODE_VOLUME_UP || keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) {
           viewModel.onVolumeButtonLongPress()
           return true
       }
       return super.onKeyLongPress(keyCode, event)
   }
   ```

5. **Override onKeyUp:**
   ```kotlin
   override fun onKeyUp(keyCode: Int, event: KeyEvent): Boolean {
       if (keyCode == KeyEvent.KEYCODE_VOLUME_UP || keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) {
           viewModel.onVolumeButtonUp()

           // Check for double-click (only if not long-press)
           if (!event.isCanceled) {
               val now = SystemClock.elapsedRealtime()
               if (now - lastVolumeClickTime < doubleClickThreshold) {
                   viewModel.onVolumeButtonDoubleClick()
                   lastVolumeClickTime = 0L
               } else {
                   lastVolumeClickTime = now
               }
           }
           return true
       }
       return super.onKeyUp(keyCode, event)
   }
   ```

6. **Observe shouldCloseApp state:**
   In setContent block, observe gestureState and call finish() when shouldCloseApp is true:
   ```kotlin
   LaunchedEffect(Unit) {
       viewModel.gestureState.collect { state ->
           if (state.shouldCloseApp) {
               viewModel.clearCloseAppFlag()
               finish()
           }
       }
   }
   ```

**Part B: Update LightScreen with double-tap detection**

1. **Add required imports:**
   ```kotlin
   import androidx.compose.foundation.gestures.detectTapGestures
   import androidx.compose.ui.input.pointer.pointerInput
   import androidx.compose.ui.hapticfeedback.HapticFeedbackType
   import androidx.compose.ui.platform.LocalHapticFeedback
   ```

2. **Add haptic feedback:**
   ```kotlin
   val haptics = LocalHapticFeedback.current
   ```

3. **Collect gestureState (for torch indicator if desired):**
   ```kotlin
   val gestureState by viewModel.gestureState.collectAsStateWithLifecycle()
   ```

4. **Add pointerInput modifier to Box with detectTapGestures:**
   ```kotlin
   Box(
       modifier = Modifier
           .fillMaxSize()
           .background(animatedColor)
           .pointerInput(Unit) {
               detectTapGestures(
                   onDoubleTap = {
                       haptics.performHapticFeedback(HapticFeedbackType.LongPress)
                       viewModel.onScreenDoubleTap()
                   }
               )
           }
   )
   ```

5. **Optional: Add torch state indicator (small icon when torch is on)**
   If torch is on, show a small flashlight icon in corner:
   ```kotlin
   if (gestureState.isTorchOn) {
       Icon(
           imageVector = Icons.Default.FlashOn,
           contentDescription = "Flashlight on",
           tint = Color.Yellow,
           modifier = Modifier
               .align(Alignment.TopEnd)
               .padding(16.dp)
       )
   }
   ```
   (This requires adding Material Icons dependency if not present - check libs.versions.toml first. If not available, skip the icon - state tracking is more important.)

**Critical imports for MainActivity:**
- android.view.KeyEvent
- android.os.SystemClock
- androidx.activity.viewModels
- androidx.compose.runtime.LaunchedEffect
  </action>
  <verify>
- `./gradlew assembleDebug` compiles without errors
- `./gradlew detekt` passes (check for line length, unused imports)
- MainActivity has onKeyDown, onKeyUp, onKeyLongPress overrides
- MainActivity observes gestureState.shouldCloseApp and calls finish()
- LightScreen has pointerInput with detectTapGestures(onDoubleTap)
- Volume buttons are consumed (return true) to prevent system volume changes
  </verify>
  <done>
Complete gesture control integration: volume button events flow through MainActivity to ViewModel for tilt/flashlight/close handling, screen double-tap toggles light on/off with haptic feedback.
  </done>
</task>

</tasks>

<verification>
Run verification commands:
```bash
./gradlew assembleDebug
./gradlew testDebugUnitTest
./gradlew detekt
```

Manual device testing required to verify:
1. Hold volume button, tilt phone - brightness and color should change
2. Long-press volume button - LED flashlight should toggle
3. Double-click volume button - app should close
4. Double-tap screen - light should toggle on/off
5. Release volume button - tilt adjustments should stop
</verification>

<success_criteria>
1. LightViewModel has GestureState with all gesture-related state
2. LightViewModel has handlers for all five gesture types (volume down, up, long-press, double-click, screen double-tap)
3. MainActivity overrides onKeyDown, onKeyUp, onKeyLongPress for volume buttons
4. MainActivity observes shouldCloseApp and calls finish() when true
5. LightScreen has detectTapGestures with onDoubleTap calling viewModel.onScreenDoubleTap()
6. Volume button events are consumed (return true) to prevent system volume popup
7. Tilt observation only active while volume button held
8. Build compiles, tests pass, detekt clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-gesture-controls-led-flashlight/03-02-SUMMARY.md`
</output>
