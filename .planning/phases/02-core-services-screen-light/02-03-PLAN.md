---
phase: 02-core-services-screen-light
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt
  - app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt
  - app/src/main/java/com/anshul/screenlight/ui/components/KeepScreenOn.kt
  - app/src/main/java/com/anshul/screenlight/ui/components/ImmersiveMode.kt
  - app/src/main/java/com/anshul/screenlight/ui/components/BatteryWarning.kt
  - app/src/main/java/com/anshul/screenlight/MainActivity.kt
autonomous: true

must_haves:
  truths:
    - "App displays full-screen solid color that stays visible while app is active"
    - "App detects ambient light on launch - if dark, starts in night vision"
    - "App remembers last used brightness and color settings across sessions"
    - "Color range spans deep red through warm to cool white"
    - "Brightness and color changes use smooth fade transitions"
    - "Screen auto-dims and shows warning when battery drops below 15%"
    - "Wake lock releases properly when app pauses"
  artifacts:
    - path: "app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt"
      provides: "Full-screen light composable with animated color"
      contains: "animateColorAsState"
    - path: "app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt"
      provides: "ViewModel with settings state and battery check"
      contains: "@HiltViewModel"
    - path: "app/src/main/java/com/anshul/screenlight/ui/components/KeepScreenOn.kt"
      provides: "Screen wake flag management"
      contains: "FLAG_KEEP_SCREEN_ON"
    - path: "app/src/main/java/com/anshul/screenlight/ui/components/ImmersiveMode.kt"
      provides: "System bars hiding for OLED burn-in prevention"
      contains: "WindowInsetsControllerCompat"
  key_links:
    - from: "LightScreen.kt"
      to: "LightViewModel"
      via: "hiltViewModel()"
      pattern: "hiltViewModel"
    - from: "LightViewModel.kt"
      to: "SettingsRepository"
      via: "constructor injection"
      pattern: "@Inject constructor.*SettingsRepository"
    - from: "LightScreen.kt"
      to: "KeepScreenOn"
      via: "composable invocation"
      pattern: "KeepScreenOn\\(\\)"
    - from: "MainActivity.kt"
      to: "LightScreen"
      via: "setContent"
      pattern: "LightScreen\\(\\)"
---

<objective>
Build full-screen light UI with smooth transitions, ambient light detection, battery warning, and lifecycle-safe screen wake

Purpose: Deliver the core screen light feature with all Phase 2 success criteria met
Output: Full-screen colored light that persists settings, detects dark environments, warns on low battery, and releases wake properly
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-services-screen-light/02-RESEARCH.md
@.planning/phases/02-core-services-screen-light/02-01-SUMMARY.md
@.planning/phases/02-core-services-screen-light/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LightViewModel with ambient light detection and battery monitoring</name>
  <files>app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt</files>
  <action>
Create ui/viewmodel/LightViewModel.kt:
```kotlin
package com.anshul.screenlight.ui.viewmodel

import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.toArgb
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.anshul.screenlight.data.model.ScreenSettings
import com.anshul.screenlight.data.repository.SettingsRepository
import com.anshul.screenlight.data.sensor.AmbientLightManager
import com.anshul.screenlight.data.sensor.BatteryMonitor
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.combine
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
import javax.inject.Inject

/**
 * UI state for the light screen.
 */
data class LightUiState(
    val settings: ScreenSettings = ScreenSettings.default(),
    val isLowBattery: Boolean = false,
    val showBatteryWarning: Boolean = false,
    val isInitialized: Boolean = false
)

@HiltViewModel
class LightViewModel @Inject constructor(
    private val settingsRepository: SettingsRepository,
    private val ambientLightManager: AmbientLightManager,
    private val batteryMonitor: BatteryMonitor
) : ViewModel() {

    private val _showBatteryWarning = MutableStateFlow(false)
    private val _isInitialized = MutableStateFlow(false)

    val uiState: StateFlow<LightUiState> = combine(
        settingsRepository.settings,
        _showBatteryWarning,
        _isInitialized
    ) { settings, showWarning, initialized ->
        val isLow = batteryMonitor.isLowBattery()
        LightUiState(
            settings = if (isLow && !batteryMonitor.isCharging()) {
                // Auto-dim to 30% brightness when low battery
                settings.copy(brightness = minOf(settings.brightness, 0.3f))
            } else {
                settings
            },
            isLowBattery = isLow,
            showBatteryWarning = showWarning,
            isInitialized = initialized
        )
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.Eagerly,
        initialValue = LightUiState()
    )

    init {
        checkAmbientLightOnLaunch()
    }

    /**
     * On first launch, check ambient light. If dark (< 50 lux), use night vision mode.
     * Otherwise use last saved settings.
     */
    private fun checkAmbientLightOnLaunch() {
        viewModelScope.launch {
            val lux = ambientLightManager.getCurrentLux()
            if (lux != null && lux < AmbientLightManager.DARK_THRESHOLD_LUX) {
                // Dark environment - switch to night vision
                settingsRepository.updateColor(ScreenSettings.NIGHT_VISION_COLOR_ARGB)
            }
            // Mark as initialized after ambient check
            _isInitialized.value = true

            // Check battery on launch
            checkBattery()
        }
    }

    /**
     * Check battery and show warning if low.
     */
    fun checkBattery() {
        if (batteryMonitor.isLowBattery() && !batteryMonitor.isCharging()) {
            _showBatteryWarning.value = true
        }
    }

    /**
     * Dismiss the battery warning dialog.
     */
    fun dismissBatteryWarning() {
        _showBatteryWarning.value = false
    }

    /**
     * Update screen brightness.
     */
    fun updateBrightness(brightness: Float) {
        viewModelScope.launch {
            settingsRepository.updateBrightness(brightness)
        }
    }

    /**
     * Update screen color.
     */
    fun updateColor(color: Color) {
        viewModelScope.launch {
            settingsRepository.updateColor(color.toArgb())
        }
    }

    /**
     * Predefined colors for the color range (deep red to cool white).
     */
    companion object {
        val COLOR_PRESETS = listOf(
            Color(0xFF8B0000), // Deep red (night vision)
            Color(0xFFCD5C5C), // Indian red
            Color(0xFFFF6347), // Tomato
            Color(0xFFFF8C00), // Dark orange
            Color(0xFFFFD700), // Gold
            Color(0xFFFFF8DC), // Cornsilk (warm white)
            Color(0xFFFFFAF0), // Floral white
            Color(0xFFF0F8FF), // Alice blue (cool white)
        )
    }
}
```
  </action>
  <verify>Run `./gradlew assembleDebug` to verify ViewModel compiles with Hilt annotation processing.</verify>
  <done>LightViewModel provides UI state with settings, battery status, and ambient light detection on launch.</done>
</task>

<task type="auto">
  <name>Task 2: Create lifecycle-aware composables for screen wake and immersive mode</name>
  <files>app/src/main/java/com/anshul/screenlight/ui/components/KeepScreenOn.kt, app/src/main/java/com/anshul/screenlight/ui/components/ImmersiveMode.kt, app/src/main/java/com/anshul/screenlight/ui/components/BatteryWarning.kt</files>
  <action>
Create ui/components/KeepScreenOn.kt:
```kotlin
package com.anshul.screenlight.ui.components

import android.app.Activity
import android.view.WindowManager
import androidx.compose.runtime.Composable
import androidx.compose.runtime.DisposableEffect
import androidx.compose.ui.platform.LocalContext

/**
 * Keeps the screen on while this composable is in the composition.
 * Uses FLAG_KEEP_SCREEN_ON which auto-releases when app goes to background.
 *
 * IMPORTANT: This is lifecycle-safe - flag is cleared in onDispose which
 * happens when the composable leaves composition (including onPause).
 */
@Composable
fun KeepScreenOn() {
    val context = LocalContext.current
    DisposableEffect(Unit) {
        val window = (context as? Activity)?.window
        window?.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)

        onDispose {
            window?.clearFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)
        }
    }
}
```

Create ui/components/ImmersiveMode.kt:
```kotlin
package com.anshul.screenlight.ui.components

import android.app.Activity
import androidx.compose.runtime.Composable
import androidx.compose.runtime.DisposableEffect
import androidx.compose.ui.platform.LocalView
import androidx.core.view.WindowCompat
import androidx.core.view.WindowInsetsCompat
import androidx.core.view.WindowInsetsControllerCompat

/**
 * Enables immersive mode (hides system bars) while in composition.
 * This prevents OLED burn-in from static status/navigation bars.
 *
 * System bars reappear with a swipe gesture and auto-hide again.
 */
@Composable
fun ImmersiveMode() {
    val view = LocalView.current
    DisposableEffect(Unit) {
        val window = (view.context as? Activity)?.window ?: return@DisposableEffect onDispose {}
        val insetsController = WindowCompat.getInsetsController(window, view)

        // Hide system bars
        insetsController.apply {
            hide(WindowInsetsCompat.Type.systemBars())
            systemBarsBehavior = WindowInsetsControllerCompat.BEHAVIOR_SHOW_TRANSIENT_BARS_BY_SWIPE
        }

        onDispose {
            // Show system bars when leaving
            insetsController.show(WindowInsetsCompat.Type.systemBars())
        }
    }
}
```

Create ui/components/BatteryWarning.kt:
```kotlin
package com.anshul.screenlight.ui.components

import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.Composable
import com.anshul.screenlight.data.sensor.BatteryMonitor

/**
 * Warning dialog shown when battery is below threshold.
 * Screen brightness is auto-dimmed to 30% when battery is low.
 */
@Composable
fun BatteryWarningDialog(
    onDismiss: () -> Unit
) {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text("Low Battery") },
        text = {
            Text(
                "Battery below ${BatteryMonitor.LOW_BATTERY_THRESHOLD}%. " +
                    "Screen brightness has been reduced to preserve battery."
            )
        },
        confirmButton = {
            TextButton(onClick = onDismiss) {
                Text("OK")
            }
        }
    )
}
```
  </action>
  <verify>Run `./gradlew assembleDebug` to verify all composables compile.</verify>
  <done>KeepScreenOn, ImmersiveMode, and BatteryWarningDialog composables created with proper lifecycle management via DisposableEffect.</done>
</task>

<task type="auto">
  <name>Task 3: Create LightScreen and wire up MainActivity</name>
  <files>app/src/main/java/com/anshul/screenlight/ui/screen/LightScreen.kt, app/src/main/java/com/anshul/screenlight/MainActivity.kt</files>
  <action>
Create ui/screen/LightScreen.kt:
```kotlin
package com.anshul.screenlight.ui.screen

import androidx.compose.animation.animateColorAsState
import androidx.compose.animation.core.FastOutSlowInEasing
import androidx.compose.animation.core.tween
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.drawBehind
import androidx.compose.ui.graphics.Color
import androidx.hilt.navigation.compose.hiltViewModel
import com.anshul.screenlight.ui.components.BatteryWarningDialog
import com.anshul.screenlight.ui.components.ImmersiveMode
import com.anshul.screenlight.ui.components.KeepScreenOn
import com.anshul.screenlight.ui.viewmodel.LightViewModel

/**
 * Full-screen light display.
 *
 * Features:
 * - Displays solid color at current brightness
 * - Smooth color/brightness transitions (300ms)
 * - Keeps screen on while active
 * - Immersive mode (hides system bars)
 * - Battery warning when low
 *
 * Color is applied via alpha for brightness control:
 * - brightness 1.0 = full color
 * - brightness 0.5 = 50% alpha (dimmed)
 * - brightness 0.0 = black
 */
@Composable
fun LightScreen(
    viewModel: LightViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    // Calculate display color with brightness applied as alpha
    val targetColor = uiState.settings.color.copy(
        alpha = uiState.settings.brightness
    )

    // Animate color changes smoothly
    val animatedColor by animateColorAsState(
        targetValue = targetColor,
        animationSpec = tween(
            durationMillis = 300,
            easing = FastOutSlowInEasing
        ),
        label = "screen_color"
    )

    // Lifecycle-aware screen management
    KeepScreenOn()
    ImmersiveMode()

    // Main light display
    Box(
        modifier = Modifier
            .fillMaxSize()
            .drawBehind {
                // Draw background color (more performant than .background())
                drawRect(animatedColor)
            }
    )

    // Battery warning dialog
    if (uiState.showBatteryWarning) {
        BatteryWarningDialog(
            onDismiss = { viewModel.dismissBatteryWarning() }
        )
    }
}

/**
 * Preview with static color (no ViewModel).
 */
@Composable
fun LightScreenPreview(
    color: Color = Color(0xFFFFF8E7),
    brightness: Float = 1.0f
) {
    val displayColor = color.copy(alpha = brightness)

    Box(
        modifier = Modifier
            .fillMaxSize()
            .drawBehind { drawRect(displayColor) }
    )
}
```

Update MainActivity.kt:
```kotlin
package com.anshul.screenlight

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.compose.material3.MaterialTheme
import com.anshul.screenlight.ui.screen.LightScreen
import dagger.hilt.android.AndroidEntryPoint

@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Enable edge-to-edge display (required for immersive mode)
        enableEdgeToEdge()

        setContent {
            MaterialTheme {
                LightScreen()
            }
        }
    }
}
```
  </action>
  <verify>Run `./gradlew assembleDebug` to verify full app builds. Run `./gradlew testDebugUnitTest` to ensure tests pass. Run `./gradlew detekt` to check for lint violations.</verify>
  <done>LightScreen displays full-screen animated color with brightness control, KeepScreenOn, ImmersiveMode, and battery warning. MainActivity wires everything together with edge-to-edge enabled.</done>
</task>

</tasks>

<verification>
1. `./gradlew assembleDebug` builds successfully
2. `./gradlew testDebugUnitTest` passes
3. `./gradlew jacocoTestReport` generates coverage report
4. `./gradlew detekt` has no violations
5. App launches showing warm white full-screen light (or deep red if in dark environment)
6. Screen stays awake while app is active
7. System bars are hidden (immersive mode)
8. If battery < 15%, warning dialog appears and brightness is capped at 30%
</verification>

<success_criteria>
All Phase 2 success criteria met:
- [x] App displays full-screen solid color that stays visible while app is active
- [x] App detects ambient light on launch - if dark, starts in night vision (deep red); otherwise uses last used color
- [x] App remembers last used brightness and color settings across sessions
- [x] Color range spans deep red through warm to cool white
- [x] Brightness and color changes use smooth fade transitions (not instant jumps)
- [x] Screen auto-dims and shows warning when battery drops below 15%
- [x] Wake lock releases properly when app pauses (no battery drain)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-services-screen-light/02-03-SUMMARY.md`
</output>
