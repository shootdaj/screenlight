---
phase: 04-launch-methods-lock-screen
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/src/main/java/com/anshul/screenlight/widget/LightWidgetProvider.kt
  - app/src/main/res/xml/light_widget_info.xml
  - app/src/main/res/layout/widget_light.xml
  - app/src/main/res/drawable/widget_bg_on.xml
  - app/src/main/res/drawable/widget_bg_off.xml
  - app/src/main/res/drawable/ic_widget_light.xml
  - app/src/main/AndroidManifest.xml
  - app/src/main/res/values/strings.xml
autonomous: true

must_haves:
  truths:
    - "Widget can be added to home screen"
    - "Tapping widget when light is off launches the app"
    - "Tapping widget when light is on closes the app"
    - "Widget appearance changes based on light state"
    - "Widget supports multiple sizes (1x1, 2x1, 2x2)"
  artifacts:
    - path: "app/src/main/java/com/anshul/screenlight/widget/LightWidgetProvider.kt"
      provides: "AppWidgetProvider for home screen widget"
      exports: ["LightWidgetProvider", "ACTION_WIDGET_TOGGLE"]
    - path: "app/src/main/res/xml/light_widget_info.xml"
      provides: "Widget metadata (sizes, update behavior)"
    - path: "app/src/main/res/layout/widget_light.xml"
      provides: "Widget layout using RemoteViews-compatible views"
  key_links:
    - from: "LightWidgetProvider"
      to: "LightStateManager"
      via: "queries isLightOn for widget state"
      pattern: "lightStateManager\\.isLightOn"
    - from: "LightWidgetProvider"
      to: "MainActivity"
      via: "starts activity when light off"
      pattern: "startActivity.*MainActivity"
    - from: "LightWidgetProvider"
      to: "ACTION_CLOSE_LIGHT"
      via: "sends broadcast when light on"
      pattern: "ACTION_CLOSE_LIGHT"
---

<objective>
Implement home screen widget for one-tap light toggle.

Purpose: Enable instant light access from home screen without opening app drawer.
Output: Resizable widget that toggles light with visual state feedback.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-launch-methods-lock-screen/04-RESEARCH.md
@.planning/phases/04-launch-methods-lock-screen/04-01-SUMMARY.md

@app/src/main/java/com/anshul/screenlight/data/state/LightStateManager.kt
@app/src/main/AndroidManifest.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget resources (layout, drawables, metadata)</name>
  <files>
    app/src/main/res/layout/widget_light.xml
    app/src/main/res/xml/light_widget_info.xml
    app/src/main/res/drawable/widget_bg_on.xml
    app/src/main/res/drawable/widget_bg_off.xml
    app/src/main/res/drawable/ic_widget_light.xml
  </files>
  <action>
1. Create widget_light.xml layout:
   - Use FrameLayout as root (RemoteViews compatible)
   - Contains ImageView (id: widget_icon) centered
   - Container has id: widget_container for click handling
   - Keep simple - just icon with background

2. Create widget_bg_on.xml (shape drawable):
   - Rounded rectangle with corners 16dp
   - Solid fill color #FFD700 (gold/yellow for "on" state)
   - Optional: padding 8dp

3. Create widget_bg_off.xml (shape drawable):
   - Rounded rectangle with corners 16dp
   - Solid fill color #333333 (dark gray for "off" state)

4. Create ic_widget_light.xml vector:
   - 48dp x 48dp viewport
   - Light bulb icon
   - White fill

5. Create light_widget_info.xml metadata:
```xml
<appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:minWidth="40dp"
    android:minHeight="40dp"
    android:targetCellWidth="1"
    android:targetCellHeight="1"
    android:maxResizeWidth="160dp"
    android:maxResizeHeight="160dp"
    android:updatePeriodMillis="0"
    android:description="@string/widget_description"
    android:initialLayout="@layout/widget_light"
    android:resizeMode="horizontal|vertical"
    android:widgetCategory="home_screen"
    android:previewLayout="@layout/widget_light" />
```

IMPORTANT: Only use RemoteViews-compatible views (FrameLayout, LinearLayout, ImageView, TextView). No ConstraintLayout, CardView, or custom views.
  </action>
  <verify>Resources compile: `./gradlew app:mergeDebugResources`</verify>
  <done>Widget layout and metadata files created with RemoteViews-compatible views</done>
</task>

<task type="auto">
  <name>Task 2: Implement LightWidgetProvider</name>
  <files>
    app/src/main/java/com/anshul/screenlight/widget/LightWidgetProvider.kt
    app/src/main/AndroidManifest.xml
    app/src/main/res/values/strings.xml
  </files>
  <action>
1. Create LightWidgetProvider extending AppWidgetProvider:
   - Companion object with ACTION_WIDGET_TOGGLE constant
   - Override onUpdate(): update widget appearance for all widget IDs
   - Override onReceive(): handle ACTION_WIDGET_TOGGLE action
   - Get LightStateManager via applicationContext (use Hilt EntryPointAccessors)

2. In onUpdate(), for each widget:
   - Query lightStateManager.isLightOn()
   - Create PendingIntent for ACTION_WIDGET_TOGGLE broadcast (include widget ID as extra)
   - Build RemoteViews with:
     - setOnClickPendingIntent on widget_container
     - setImageViewResource for icon
     - setInt for background resource based on state
   - Call appWidgetManager.updateAppWidget()
   - IMPORTANT: Use PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE

3. In onReceive() for ACTION_WIDGET_TOGGLE:
   - Query current light state
   - If on: send ACTION_CLOSE_LIGHT broadcast, set state false
   - If off: launch MainActivity with FLAG_ACTIVITY_NEW_TASK, set state true
   - Update widget immediately via AppWidgetManager
   - Send ACTION_LIGHT_STATE_CHANGED broadcast for tile sync

4. In AndroidManifest.xml, add receiver:
```xml
<receiver
    android:name=".widget.LightWidgetProvider"
    android:exported="true">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <intent-filter>
        <action android:name="com.anshul.screenlight.WIDGET_TOGGLE" />
    </intent-filter>
    <meta-data
        android:name="android.appwidget.provider"
        android:resource="@xml/light_widget_info" />
</receiver>
```

5. Add string resources: widget_description = "Toggle Screenlight on/off"
  </action>
  <verify>
Build succeeds: `./gradlew app:assembleDebug`
Grep for widget in manifest: `grep -q "LightWidgetProvider" app/src/main/AndroidManifest.xml`
  </verify>
  <done>LightWidgetProvider registered in manifest with toggle behavior implemented</done>
</task>

</tasks>

<verification>
1. `./gradlew app:assembleDebug` completes without errors
2. Widget layout uses only RemoteViews-compatible views
3. LightWidgetProvider.kt handles onUpdate and ACTION_WIDGET_TOGGLE
4. AndroidManifest.xml includes receiver with appwidget.provider metadata
5. PendingIntent uses FLAG_IMMUTABLE for Android 12+ compatibility
</verification>

<success_criteria>
- App builds successfully
- Widget can be added to home screen (manual verification on device)
- Widget toggles light state when tapped
- Widget appearance updates based on light state
- Widget works at different sizes
</success_criteria>

<output>
After completion, create `.planning/phases/04-launch-methods-lock-screen/04-03-SUMMARY.md`
</output>
