---
phase: 04-launch-methods-lock-screen
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/src/main/java/com/anshul/screenlight/service/LightTileService.kt
  - app/src/main/AndroidManifest.xml
  - app/src/main/res/drawable/ic_tile_light.xml
  - app/src/main/res/values/strings.xml
autonomous: true

must_haves:
  truths:
    - "Quick Settings tile appears in notification shade"
    - "Tapping tile when light is off launches the app"
    - "Tapping tile when light is on closes the app"
    - "Tile icon reflects current light state (on/off)"
  artifacts:
    - path: "app/src/main/java/com/anshul/screenlight/service/LightTileService.kt"
      provides: "TileService for Quick Settings toggle"
      exports: ["LightTileService"]
    - path: "app/src/main/res/drawable/ic_tile_light.xml"
      provides: "Vector drawable for tile icon"
  key_links:
    - from: "LightTileService"
      to: "LightStateManager"
      via: "queries isLightOn for tile state"
      pattern: "lightStateManager\\.isLightOn"
    - from: "LightTileService"
      to: "MainActivity"
      via: "startActivityAndCollapse when light off"
      pattern: "startActivityAndCollapse"
    - from: "LightTileService"
      to: "ACTION_CLOSE_LIGHT"
      via: "sends broadcast when light on"
      pattern: "ACTION_CLOSE_LIGHT"
---

<objective>
Implement Quick Settings tile for toggling light from notification shade.

Purpose: Enable one-tap light control from anywhere without opening app drawer.
Output: Working QS tile that toggles light on/off with visual state indication.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-launch-methods-lock-screen/04-RESEARCH.md
@.planning/phases/04-launch-methods-lock-screen/04-01-SUMMARY.md

@app/src/main/java/com/anshul/screenlight/data/state/LightStateManager.kt
@app/src/main/AndroidManifest.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tile icon drawable</name>
  <files>
    app/src/main/res/drawable/ic_tile_light.xml
  </files>
  <action>
Create a simple vector drawable for the QS tile icon:
- 24dp x 24dp viewport
- Light bulb or flashlight shape
- Use white fill (android:fillColor="#FFFFFF") - system will tint based on tile state
- Keep simple to render well at small sizes

Use Material Design icon style (24dp, 2dp stroke equivalent for outlines).
  </action>
  <verify>File exists and is valid XML: `cat app/src/main/res/drawable/ic_tile_light.xml`</verify>
  <done>Tile icon drawable exists and renders correctly</done>
</task>

<task type="auto">
  <name>Task 2: Implement LightTileService</name>
  <files>
    app/src/main/java/com/anshul/screenlight/service/LightTileService.kt
    app/src/main/AndroidManifest.xml
    app/src/main/res/values/strings.xml
  </files>
  <action>
1. Create LightTileService extending TileService:
   - Inject LightStateManager (use applicationContext to get from Hilt since TileService isn't Hilt-injectable by default - use EntryPointAccessors)
   - Override onStartListening(): update tile state from lightStateManager.isLightOn()
   - Override onClick():
     - If light on: send ACTION_CLOSE_LIGHT broadcast
     - If light off: startActivityAndCollapse(Intent to MainActivity with FLAG_ACTIVITY_NEW_TASK)
   - Use Tile.STATE_ACTIVE when on, Tile.STATE_INACTIVE when off
   - Set icon from ic_tile_light
   - Set label from string resource

2. Register BroadcastReceiver in onCreate/onDestroy for ACTION_LIGHT_STATE_CHANGED to trigger tile refresh

3. In AndroidManifest.xml, add service declaration:
```xml
<service
    android:name=".service.LightTileService"
    android:exported="true"
    android:icon="@drawable/ic_tile_light"
    android:label="@string/tile_label"
    android:permission="android.permission.BIND_QUICK_SETTINGS_TILE">
    <intent-filter>
        <action android:name="android.service.quicksettings.action.QS_TILE" />
    </intent-filter>
    <meta-data
        android:name="android.service.quicksettings.ACTIVE_TILE"
        android:value="true" />
    <meta-data
        android:name="android.service.quicksettings.TOGGLEABLE_TILE"
        android:value="true" />
</service>
```

4. Add string resource: tile_label = "Screenlight"

Use RECEIVER_NOT_EXPORTED when registering broadcast receiver for Android 14+ security.
  </action>
  <verify>
Build succeeds: `./gradlew app:assembleDebug`
Grep for TileService in manifest: `grep -q "LightTileService" app/src/main/AndroidManifest.xml`
  </verify>
  <done>LightTileService registered in manifest and implements toggle behavior</done>
</task>

</tasks>

<verification>
1. `./gradlew app:assembleDebug` completes without errors
2. LightTileService.kt extends TileService with onClick and onStartListening implementations
3. Tile icon drawable exists at app/src/main/res/drawable/ic_tile_light.xml
4. AndroidManifest.xml includes service declaration with BIND_QUICK_SETTINGS_TILE permission
</verification>

<success_criteria>
- App builds successfully
- QS tile can be added to notification shade (manual verification on device)
- Tile toggles light state when tapped
- Tile icon updates to reflect current state
</success_criteria>

<output>
After completion, create `.planning/phases/04-launch-methods-lock-screen/04-02-SUMMARY.md`
</output>
