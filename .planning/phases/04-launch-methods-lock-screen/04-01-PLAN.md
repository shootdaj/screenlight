---
phase: 04-launch-methods-lock-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/main/java/com/anshul/screenlight/MainActivity.kt
  - app/src/main/java/com/anshul/screenlight/data/state/LightStateManager.kt
  - app/src/main/AndroidManifest.xml
  - app/src/main/res/values/strings.xml
autonomous: true

must_haves:
  truths:
    - "Light displays over lock screen without requiring unlock"
    - "Light state (on/off) is tracked centrally and broadcasts changes"
    - "Activity turns on screen when launched from lock screen"
  artifacts:
    - path: "app/src/main/java/com/anshul/screenlight/data/state/LightStateManager.kt"
      provides: "Central light state tracking with broadcast emissions"
      exports: ["LightStateManager", "ACTION_LIGHT_STATE_CHANGED", "ACTION_CLOSE_LIGHT"]
    - path: "app/src/main/java/com/anshul/screenlight/MainActivity.kt"
      provides: "Lock screen display and close action receiver"
      contains: "setShowWhenLocked"
  key_links:
    - from: "MainActivity.kt"
      to: "LightStateManager"
      via: "updates isLightOn on start/stop"
      pattern: "lightStateManager\\.(setLightOn|updateState)"
    - from: "MainActivity.kt"
      to: "broadcast ACTION_CLOSE_LIGHT"
      via: "BroadcastReceiver finishes Activity"
      pattern: "ACTION_CLOSE_LIGHT"
---

<objective>
Create shared light state management infrastructure and enable lock screen display.

Purpose: Foundation for QS tile, widget, and shake detection to query/control light state. Lock screen support enables shake-to-launch from locked device.
Output: LightStateManager singleton, MainActivity with lock screen flags and close receiver.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-launch-methods-lock-screen/04-RESEARCH.md

@app/src/main/java/com/anshul/screenlight/MainActivity.kt
@app/src/main/java/com/anshul/screenlight/ui/viewmodel/LightViewModel.kt
@app/src/main/AndroidManifest.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LightStateManager for centralized state tracking</name>
  <files>
    app/src/main/java/com/anshul/screenlight/data/state/LightStateManager.kt
    app/src/main/java/com/anshul/screenlight/di/AppModule.kt
  </files>
  <action>
Create LightStateManager as a Hilt singleton that:
1. Tracks `isLightOn: Boolean` state
2. Broadcasts ACTION_LIGHT_STATE_CHANGED when state changes
3. Provides ACTION_CLOSE_LIGHT constant for external close requests
4. Uses SharedPreferences for persistence across process death (key: "light_on" in "app_state" preferences)
5. Exposes `setLightOn(Boolean)` and `isLightOn(): Boolean` methods
6. Broadcasts use LocalBroadcastManager for internal communication, and standard sendBroadcast for external (tile, widget)

Add companion object constants:
- ACTION_LIGHT_STATE_CHANGED = "com.anshul.screenlight.LIGHT_STATE_CHANGED"
- ACTION_CLOSE_LIGHT = "com.anshul.screenlight.CLOSE_LIGHT"

Register as @Singleton in AppModule.
  </action>
  <verify>Build succeeds: `./gradlew app:compileDebugKotlin`</verify>
  <done>LightStateManager exists with state tracking and broadcast capabilities, registered in Hilt DI</done>
</task>

<task type="auto">
  <name>Task 2: Enable lock screen display and integrate state management</name>
  <files>
    app/src/main/java/com/anshul/screenlight/MainActivity.kt
    app/src/main/AndroidManifest.xml
    app/src/main/res/values/strings.xml
  </files>
  <action>
1. In AndroidManifest.xml, add to MainActivity:
   - android:showWhenLocked="true"
   - android:turnScreenOn="true"

2. In MainActivity.onCreate():
   - Add programmatic setShowWhenLocked(true) and setTurnScreenOn(true) for API 27+ (fallback to window flags for older)
   - Inject LightStateManager
   - Call lightStateManager.setLightOn(true) in onCreate
   - Register BroadcastReceiver for ACTION_CLOSE_LIGHT that calls finish()

3. In MainActivity.onDestroy():
   - Call lightStateManager.setLightOn(false)
   - Unregister BroadcastReceiver

4. Add string resources for any new UI text (notification channel name if needed later)

DO NOT call requestDismissKeyguard() - leave lock screen intact behind the light.
Use RECEIVER_NOT_EXPORTED flag when registering broadcast receiver (Android 14+ security).
  </action>
  <verify>
Build succeeds: `./gradlew app:assembleDebug`
Manifest contains showWhenLocked and turnScreenOn attributes
  </verify>
  <done>MainActivity displays over lock screen and updates LightStateManager on lifecycle changes</done>
</task>

</tasks>

<verification>
1. `./gradlew app:assembleDebug` completes without errors
2. LightStateManager.kt exists with ACTION_LIGHT_STATE_CHANGED and ACTION_CLOSE_LIGHT constants
3. MainActivity.kt contains setShowWhenLocked(true) call
4. AndroidManifest.xml has showWhenLocked="true" on MainActivity
</verification>

<success_criteria>
- App builds successfully
- LightStateManager tracks light state with SharedPreferences persistence
- MainActivity configured for lock screen display
- Close action broadcast infrastructure ready for tile/widget/shake to use
</success_criteria>

<output>
After completion, create `.planning/phases/04-launch-methods-lock-screen/04-01-SUMMARY.md`
</output>
