name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      checks: write
      pull-requests: write
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run tests with coverage
        run: ./gradlew testDebugUnitTest jacocoTestReport

      - name: Generate JaCoCo Badge
        id: jacoco
        uses: Madrapps/jacoco-report@v1.7.2
        with:
          paths: ${{ github.workspace }}/**/build/reports/jacoco/**/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 20
          min-coverage-changed-files: 20
          title: Code Coverage

      - name: Fail if coverage < 20%
        if: ${{ steps.jacoco.outputs.coverage-overall < 20.0 }}
        uses: actions/github-script@v7
        with:
          script: core.setFailed('Overall coverage is less than 20%!')

      - name: Run Detekt
        run: ./gradlew detektMain detektTest --continue || true

      - name: Find Detekt SARIF files
        id: find-sarif
        run: |
          SARIF_FILES=$(find . -path "*/build/reports/detekt/*.sarif" -type f 2>/dev/null | head -1)
          if [ -n "$SARIF_FILES" ]; then
            echo "sarif_file=$SARIF_FILES" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Detekt SARIF
        if: always() && steps.find-sarif.outputs.found == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.find-sarif.outputs.sarif_file }}
