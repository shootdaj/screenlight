---
phase: 01-project-setup-ci-cd
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Push to main or PR to main triggers CI workflow"
    - "CI workflow runs tests, enforces 80% coverage, and runs Detekt"
    - "Pushing tag v*.*.* triggers release workflow"
    - "Release workflow creates GitHub release with debug APK attached"
    - "Main branch is protected: PRs required, status checks required, no admin bypass"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow for PRs and main branch pushes"
      contains: "Madrapps/jacoco-report"
    - path: ".github/workflows/release.yml"
      provides: "Release workflow triggered by version tags"
      contains: "softprops/action-gh-release"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "Gradle test task"
      via: "./gradlew testDebugUnitTest"
      pattern: "gradlew.*testDebugUnitTest"
    - from: ".github/workflows/ci.yml"
      to: "branch protection status checks"
      via: "job name 'test'"
      pattern: "jobs:\\s+test:"
    - from: ".github/workflows/release.yml"
      to: "GitHub release creation"
      via: "softprops/action-gh-release"
      pattern: "softprops/action-gh-release"
---

<objective>
Create GitHub Actions workflows for CI (tests, coverage, lint) and automated releases, then configure branch protection rules.

Purpose: Enforce quality gates on every PR and automate the release process. This completes the CI/CD pipeline requirements (CICD-01 through CICD-07).

Output: Two workflow files and configured branch protection. PRs to main require passing CI. Tags matching v*.*.* create releases with APK.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup-ci-cd/01-RESEARCH.md
@.planning/phases/01-project-setup-ci-cd/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI workflow for tests, coverage, and lint</name>
  <files>.github/workflows/ci.yml</files>
  <action>
    Create `.github/workflows/ci.yml` with the complete CI workflow from RESEARCH.md:

    ```yaml
    name: CI

    on:
      pull_request:
        branches: [main]
      push:
        branches: [main]

    jobs:
      test:
        runs-on: ubuntu-latest

        permissions:
          checks: write
          pull-requests: write
          contents: read

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Validate Gradle wrapper
            uses: gradle/actions/wrapper-validation@v3

          - name: Set up JDK 17
            uses: actions/setup-java@v4
            with:
              distribution: 'temurin'
              java-version: '17'

          - name: Setup Gradle
            uses: gradle/actions/setup-gradle@v4

          - name: Run tests with coverage
            run: ./gradlew testDebugUnitTest jacocoTestReport

          - name: Generate JaCoCo Badge
            id: jacoco
            uses: Madrapps/jacoco-report@v1.9.0
            with:
              paths: ${{ github.workspace }}/**/build/reports/jacoco/**/jacocoTestReport.xml
              token: ${{ secrets.GITHUB_TOKEN }}
              min-coverage-overall: 80
              min-coverage-changed-files: 80
              title: Code Coverage

          - name: Fail if coverage < 80%
            if: ${{ steps.jacoco.outputs.coverage-overall < 80.0 }}
            uses: actions/github-script@v7
            with:
              script: core.setFailed('Overall coverage is less than 80%!')

          - name: Run Detekt
            run: ./gradlew detekt

          - name: Upload Detekt SARIF
            if: always()
            uses: github/codeql-action/upload-sarif@v3
            with:
              sarif_file: app/build/reports/detekt/detekt.sarif
    ```

    Key points:
    - Job name is `test` (this becomes the required status check)
    - Uses Madrapps/jacoco-report for PR comments and coverage threshold
    - Fails build if coverage < 80% using actions/github-script
    - Uploads Detekt SARIF for GitHub code scanning integration
    - Wrapper validation runs BEFORE any Gradle execution (security)
  </action>
  <verify>
    cat .github/workflows/ci.yml | grep -E "(on:|pull_request:|push:|Madrapps/jacoco-report|min-coverage-overall: 80|gradlew detekt)"
  </verify>
  <done>
    CI workflow file exists with:
    - Triggers on PR and push to main
    - Coverage threshold of 80%
    - Detekt lint step
  </done>
</task>

<task type="auto">
  <name>Task 2: Create release workflow for tag-triggered APK releases</name>
  <files>.github/workflows/release.yml</files>
  <action>
    Create `.github/workflows/release.yml`:

    ```yaml
    name: Release

    on:
      push:
        tags:
          - 'v*.*.*'

    jobs:
      build-and-release:
        runs-on: ubuntu-latest

        permissions:
          contents: write

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Validate Gradle wrapper
            uses: gradle/actions/wrapper-validation@v3

          - name: Set up JDK 17
            uses: actions/setup-java@v4
            with:
              distribution: 'temurin'
              java-version: '17'

          - name: Setup Gradle
            uses: gradle/actions/setup-gradle@v4

          - name: Build debug APK
            run: ./gradlew assembleDebug

          - name: Create Release
            uses: softprops/action-gh-release@v2
            with:
              files: app/build/outputs/apk/debug/*.apk
              generate_release_notes: true
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    ```

    Key points:
    - Triggers only on tags matching v*.*.* pattern (semantic versioning)
    - Builds debug APK (not release - per PROJECT.md, debug signing is sufficient)
    - Uses softprops/action-gh-release for release creation
    - Auto-generates release notes from commits
    - permissions.contents: write required for creating releases
  </action>
  <verify>
    cat .github/workflows/release.yml | grep -E "(tags:|'v\*\.\*\.\*'|assembleDebug|softprops/action-gh-release)"
  </verify>
  <done>
    Release workflow file exists with:
    - Tag trigger pattern v*.*.*
    - Debug APK build
    - GitHub release creation with APK attachment
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure branch protection for main</name>
  <files>N/A (GitHub API configuration)</files>
  <action>
    Use GitHub CLI to configure branch protection rules for main branch:

    ```bash
    # Get repo info
    OWNER=$(gh repo view --json owner -q .owner.login)
    REPO=$(gh repo view --json name -q .name)

    # Configure branch protection
    gh api repos/$OWNER/$REPO/branches/main/protection \
      --method PUT \
      -H "Accept: application/vnd.github+json" \
      --field required_status_checks='{"strict":true,"contexts":["test"]}' \
      --field enforce_admins=true \
      --field required_pull_request_reviews='{"required_approving_review_count":1,"dismiss_stale_reviews":true}' \
      --field restrictions=null \
      --field allow_force_pushes=false \
      --field allow_deletions=false
    ```

    Requirements satisfied:
    - CICD-04: Main branch is protected with required PR reviews (required_approving_review_count: 1)
    - CICD-05: No admin bypass (enforce_admins: true)
    - CICD-07: GitHub Flow (feature branches merged via PR)
    - Status checks required: "test" job must pass
    - Strict mode: Branch must be up-to-date with main before merge

    NOTE: The workflow files must be pushed to main BEFORE configuring branch protection, otherwise the "test" status check won't exist yet.

    Execution order:
    1. Commit and push workflow files to main
    2. Wait for CI to run at least once (creates the status check)
    3. Then configure branch protection
  </action>
  <verify>
    gh api repos/$(gh repo view --json owner -q .owner.login)/$(gh repo view --json name -q .name)/branches/main/protection --jq '.enforce_admins.enabled, .required_status_checks.contexts[]'
  </verify>
  <done>
    Branch protection configured with:
    - enforce_admins.enabled = true (no admin bypass)
    - required_status_checks.contexts includes "test"
  </done>
</task>

</tasks>

<verification>
1. Workflow files exist:
   - `.github/workflows/ci.yml` present
   - `.github/workflows/release.yml` present

2. CI workflow triggers correctly:
   - Create a test branch, push, open PR -> CI should run
   - Check GitHub Actions tab for "CI" workflow execution

3. Branch protection active:
   - `gh api repos/{owner}/{repo}/branches/main/protection` returns configuration
   - enforce_admins.enabled = true
   - required_status_checks.contexts = ["test"]

4. Release workflow (test after phase complete):
   - Create and push tag: `git tag v0.0.1 && git push origin v0.0.1`
   - Check GitHub Releases for new release with APK attachment
</verification>

<success_criteria>
- CI workflow runs on PR to main and reports test results
- Coverage < 80% fails the PR (blocked)
- Detekt violations fail the PR (blocked)
- Pushing v*.*.* tag creates GitHub release with debug APK
- Main branch requires PR with passing checks (no direct push)
- Admin users cannot bypass protection rules
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-ci-cd/01-02-SUMMARY.md`
</output>
