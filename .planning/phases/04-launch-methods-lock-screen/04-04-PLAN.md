---
phase: 04-launch-methods-lock-screen
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/src/main/java/com/anshul/screenlight/service/ShakeDetectionService.kt
  - app/src/main/java/com/anshul/screenlight/service/ShakeDetector.kt
  - app/src/main/java/com/anshul/screenlight/data/preferences/ShakePreferences.kt
  - app/src/main/java/com/anshul/screenlight/MainActivity.kt
  - app/src/main/AndroidManifest.xml
  - app/src/main/res/values/strings.xml
  - app/src/main/res/drawable/ic_notification_shake.xml
autonomous: true

must_haves:
  truths:
    - "Shaking phone when app is closed launches the app"
    - "Shaking phone when app is active turns off the light and closes"
    - "Shake detection works from lock screen"
    - "Vibration pulse confirms shake detection"
    - "Shake has 1-second cooldown to prevent rapid toggling"
  artifacts:
    - path: "app/src/main/java/com/anshul/screenlight/service/ShakeDetectionService.kt"
      provides: "Foreground service for background shake detection"
      exports: ["ShakeDetectionService"]
    - path: "app/src/main/java/com/anshul/screenlight/service/ShakeDetector.kt"
      provides: "Shake detection algorithm (adapted from Square Seismic)"
      exports: ["ShakeDetector", "SENSITIVITY_LIGHT", "SENSITIVITY_MEDIUM", "SENSITIVITY_HARD"]
    - path: "app/src/main/java/com/anshul/screenlight/data/preferences/ShakePreferences.kt"
      provides: "Shake sensitivity and enabled state preferences"
      exports: ["ShakePreferences"]
  key_links:
    - from: "ShakeDetectionService"
      to: "ShakeDetector"
      via: "sensor events forwarded to detector"
      pattern: "shakeDetector\\.onSensorChanged"
    - from: "ShakeDetectionService"
      to: "MainActivity"
      via: "launches on shake when app closed"
      pattern: "startActivity.*MainActivity"
    - from: "ShakeDetectionService"
      to: "ACTION_CLOSE_LIGHT"
      via: "sends close when app active"
      pattern: "ACTION_CLOSE_LIGHT"
    - from: "ShakeDetectionService"
      to: "LightStateManager"
      via: "queries light state to decide launch vs close"
      pattern: "lightStateManager\\.isLightOn"
---

<objective>
Implement shake gesture detection for hands-free light activation.

Purpose: Enable launching light by shaking phone from anywhere, including lock screen. Core use case is "fumbling in the dark."
Output: Foreground service with shake detection that toggles light with haptic confirmation.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-launch-methods-lock-screen/04-RESEARCH.md
@.planning/phases/04-launch-methods-lock-screen/04-01-SUMMARY.md

@app/src/main/java/com/anshul/screenlight/data/state/LightStateManager.kt
@app/src/main/java/com/anshul/screenlight/MainActivity.kt
@app/src/main/AndroidManifest.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShakeDetector algorithm and ShakePreferences</name>
  <files>
    app/src/main/java/com/anshul/screenlight/service/ShakeDetector.kt
    app/src/main/java/com/anshul/screenlight/data/preferences/ShakePreferences.kt
  </files>
  <action>
1. Create ShakeDetector.kt (adapted from Square Seismic algorithm):
   - Companion object with sensitivity constants: SENSITIVITY_LIGHT = 11, SENSITIVITY_MEDIUM = 13, SENSITIVITY_HARD = 15
   - Private SampleQueue class to track accelerometer samples
   - setSensitivity(Int) method
   - setListener(() -> Unit) for shake callback
   - onSensorChanged(SensorEvent) to process accelerometer data
   - stop() to clear queue

   Algorithm logic (from Seismic):
   - Calculate magnitude squared from x, y, z values
   - Compare against threshold (sensitivity * 2.5) squared
   - Add sample to queue with timestamp and accelerating boolean
   - Queue tracks last 40 samples (~0.5s at SENSOR_DELAY_GAME)
   - Shake detected when 3/4 of samples in 0.25s+ window are accelerating
   - Call listener when shake detected, then clear queue

2. Create ShakePreferences.kt:
   - Uses SharedPreferences ("shake_prefs")
   - isEnabled: Boolean (default true)
   - sensitivity: Int (default SENSITIVITY_LIGHT)
   - Provide getter/setter methods

DO NOT use third-party libraries - copy algorithm source. Seismic library is archived.
  </action>
  <verify>Build succeeds: `./gradlew app:compileDebugKotlin`</verify>
  <done>ShakeDetector implements proven Seismic algorithm, ShakePreferences stores settings</done>
</task>

<task type="auto">
  <name>Task 2: Create ShakeDetectionService foreground service</name>
  <files>
    app/src/main/java/com/anshul/screenlight/service/ShakeDetectionService.kt
    app/src/main/res/drawable/ic_notification_shake.xml
    app/src/main/res/values/strings.xml
  </files>
  <action>
1. Create ic_notification_shake.xml vector drawable:
   - Simple phone/shake icon for notification
   - 24dp viewport, white fill

2. Create ShakeDetectionService extending Service, implementing SensorEventListener:
   - Get LightStateManager via Hilt EntryPointAccessors
   - Get SensorManager and Vibrator from system services
   - Create ShakeDetector instance
   - SHAKE_COOLDOWN_MS = 1000L constant
   - lastShakeTime tracking

3. In onCreate():
   - Create notification channel "shake_detection" with IMPORTANCE_LOW
   - Get accelerometer sensor

4. In onStartCommand():
   - Load sensitivity from ShakePreferences
   - Configure ShakeDetector with sensitivity and listener
   - Register sensor listener with SENSOR_DELAY_GAME
   - Start foreground with notification (ID 1001)
   - Return START_STICKY

5. Shake listener callback (onShakeDetected):
   - Check cooldown (now - lastShakeTime < 1000ms -> ignore)
   - Update lastShakeTime
   - Provide haptic feedback:
     - API 29+: VibrationEffect.createPredefined(EFFECT_CLICK)
     - API 26+: VibrationEffect.createOneShot(50, DEFAULT_AMPLITUDE)
     - Below: vibrator.vibrate(50)
   - Query lightStateManager.isLightOn():
     - If on: send ACTION_CLOSE_LIGHT broadcast
     - If off: launch MainActivity with FLAG_ACTIVITY_NEW_TASK

6. In onDestroy():
   - Unregister sensor listener
   - shakeDetector.stop()

7. onBind returns null (not a bound service)

8. Notification content:
   - Title: "Shake to activate light"
   - Text: "Shake detection is active"
   - Icon: ic_notification_shake
   - Add action to disable shake detection (optional - Claude's discretion)
  </action>
  <verify>Build succeeds: `./gradlew app:compileDebugKotlin`</verify>
  <done>ShakeDetectionService implements foreground service with sensor listening and shake handling</done>
</task>

<task type="auto">
  <name>Task 3: Register service in manifest and add permissions</name>
  <files>
    app/src/main/AndroidManifest.xml
    app/src/main/java/com/anshul/screenlight/MainActivity.kt
  </files>
  <action>
1. Add permissions to AndroidManifest.xml:
```xml
<uses-permission android:name="android.permission.VIBRATE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
```

2. Add service declaration:
```xml
<service
    android:name=".service.ShakeDetectionService"
    android:exported="false"
    android:foregroundServiceType="specialUse">
    <property
        android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
        android:value="shake_detection" />
</service>
```

3. In MainActivity.onCreate():
   - Start ShakeDetectionService if ShakePreferences.isEnabled
   - Use ContextCompat.startForegroundService() for compatibility

4. Optional: In MainActivity.onDestroy() when finishing normally:
   - Could stop service, but research suggests leaving it running for background launch
   - Decision: Leave service running - it's the point (shake from anywhere)

Note: Android 14+ requires foregroundServiceType="specialUse" for sensor access in background.
POST_NOTIFICATIONS permission needed for Android 13+ to show foreground notification.
  </action>
  <verify>
Build succeeds: `./gradlew app:assembleDebug`
Manifest contains VIBRATE and FOREGROUND_SERVICE permissions
Manifest contains service with foregroundServiceType
  </verify>
  <done>ShakeDetectionService registered with proper permissions, started from MainActivity</done>
</task>

</tasks>

<verification>
1. `./gradlew app:assembleDebug` completes without errors
2. ShakeDetector.kt implements Seismic algorithm with 3/4 samples rule
3. ShakeDetectionService.kt uses foreground service with notification
4. AndroidManifest.xml includes VIBRATE, FOREGROUND_SERVICE, FOREGROUND_SERVICE_SPECIAL_USE permissions
5. Service declaration includes foregroundServiceType="specialUse"
</verification>

<success_criteria>
- App builds successfully
- Shake detection service starts and shows notification
- Shaking phone launches app when closed (manual verification on device)
- Shaking phone while app active closes it (manual verification on device)
- Vibration confirms shake detection
- 1-second cooldown prevents rapid toggling
</success_criteria>

<output>
After completion, create `.planning/phases/04-launch-methods-lock-screen/04-04-SUMMARY.md`
</output>
